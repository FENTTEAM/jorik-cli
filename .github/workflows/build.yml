name: build
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    name: build (Linux x64)
    runs-on: ubuntu-latest
    env:
      BIN_NAME: jorik-cli
      TARGET: x86_64-unknown-linux-gnu

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ runner.os }}-${{ env.TARGET }}
      - run: cargo build --release --target ${{ env.TARGET }}
      - name: Package
        shell: bash
        run: |
          OUT="target/${{ env.TARGET }}/release/${{ env.BIN_NAME }}"
          mkdir -p dist
          cp "$OUT" "dist/jorik"
          tar -C dist -czf "dist/jorik-${{ env.TARGET }}.tar.gz" "jorik"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BIN_NAME }}-${{ env.TARGET }}
          path: dist/*

  build-windows:
    name: build (Windows x64)
    runs-on: windows-latest
    env:
      BIN_NAME: jorik-cli
      TARGET: x86_64-pc-windows-msvc

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ runner.os }}-${{ env.TARGET }}
      
      - name: Install Inno Setup
        run: choco install innosetup

      - name: Get version
        shell: pwsh
        run: |
          $versionLine = Get-Content Cargo.toml | Where-Object { $_ -match '^version' } | Select-Object -First 1
          $version = ($versionLine -split '"')[1]
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Build
        shell: pwsh
        run: |
          cargo build --release --target ${{ env.TARGET }}

      - name: Package binary (zip)
        shell: pwsh
        run: |
          $src = "target\${{ env.TARGET }}\release\jorik-cli.exe"
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $renamed = "dist\jorik.exe"
          Copy-Item $src $renamed -Force
          Compress-Archive -Path $renamed -DestinationPath "dist\jorik-${{ env.TARGET }}.zip" -Force

      - name: Build installer
        shell: pwsh
        run: |
          Copy-Item "target\${{ env.TARGET }}\release\jorik-cli.exe" "target\${{ env.TARGET }}\release\jorik.exe" -Force
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DMyAppVersion=${{ env.VERSION }} /DMyTarget=${{ env.TARGET }} installer\jorik-cli.iss

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BIN_NAME }}-${{ env.TARGET }}
          path: dist/*

  release:
    needs:
      - build-linux
      - build-windows
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          VERSION=$(grep "^version" Cargo.toml | head -n 1 | cut -d '"' -f 2)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # Check if version ends with -{letter} (single letter) or basically any pre-release suffix
          if [[ "$VERSION" =~ -[a-zA-Z]$ ]]; then
            echo "IS_PRERELEASE=true" >> $GITHUB_ENV
          elif [[ "$VERSION" == *"-"* ]]; then
             # Broader catch for things like -alpha, -beta if needed, but strict request was -{letter}
             # strict interpretation: 0.4.0-a
             echo "IS_PRERELEASE=true" >> $GITHUB_ENV
          else
            echo "IS_PRERELEASE=false" >> $GITHUB_ENV
          fi

      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/*.tar.gz
            artifacts/*.zip
            artifacts/*setup.exe
          prerelease: ${{ env.IS_PRERELEASE }}
          name: Release v${{ env.VERSION }}
          generate_release_notes: true